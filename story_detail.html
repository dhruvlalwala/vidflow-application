{% extends 'base.html' %}

{% block title %}Stories by {{ author.username }}{% endblock %}

{% block content %}
<div class="flex items-center justify-center h-full">
    <div id="story-container" class="relative w-full max-w-xl mx-auto rounded-xl overflow-hidden shadow-2xl bg-black border border-white/10" style="aspect-ratio: 9/16;">

        <div id="story-bg-container" class="absolute inset-0 z-0 bg-cover bg-center filter blur-lg"></div>

        <div id="story-media-container" class="absolute inset-0 w-full h-full flex items-center justify-center z-10">
            </div>

        <div class="absolute top-0 left-0 right-0 p-4 z-20">
            <div id="progress-bar-container" class="flex space-x-1 mb-2">
                </div>
            <div class="flex items-center justify-between mt-2">
                <div class="flex items-center">
                    <img src="{{ url_for('static', filename='profile_pics/' + author.profile_pic) }}" 
                         alt="{{ author.username }}" class="h-8 w-8 rounded-full object-cover border-2 border-white">
                    <span class="ml-2 font-semibold text-white">{{ author.username }}</span>
                </div>
                <a href="{{ url_for('main.feed') }}" class="text-white hover:text-gray-400 p-1 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </a>
            </div>
        </div>

        <div class="absolute inset-0 flex items-center justify-between z-10">
            <button id="prev-story-btn" class="text-white h-full px-2" style="text-shadow: 0 0 5px black;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <button id="next-story-btn" class="text-white h-full px-2" style="text-shadow: 0 0 5px black;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <div id="delete-btn-container" class="absolute bottom-4 right-4 z-20">
            </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const storiesData = {{ stories | tojson }};
        const start_index = {{ start_index }};
        const storyContainer = document.getElementById('story-container');
        const storyMediaContainer = document.getElementById('story-media-container');
        const storyBgContainer = document.getElementById('story-bg-container');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const prevBtn = document.getElementById('prev-story-btn');
        const nextBtn = document.getElementById('next-story-btn');
        const deleteBtnContainer = document.getElementById('delete-btn-container');

        let currentStoryIndex = start_index;

        function renderStory(index) {
            const story = storiesData[index];
            if (!story) return;

            window.history.pushState(null, '', `?story_id=${story.id}`);

            storyMediaContainer.innerHTML = '';
            storyBgContainer.style.backgroundImage = '';

            const fileExtension = story.filename.split('.').pop().toLowerCase();
            const mediaUrl = `{{ url_for('static', filename='story_pics/') }}${story.filename}`;

            // Set the blurred background
            storyBgContainer.style.backgroundImage = `url('${mediaUrl}')`;

            if (['mp4', 'mov', 'avi'].includes(fileExtension)) {
                const video = document.createElement('video');
                // Change: Use object-contain for the main media to show the whole image
                video.className = 'w-full h-full object-contain';
                video.controls = false;
                video.autoplay = true;
                video.muted = false;
                video.src = mediaUrl;
                storyMediaContainer.appendChild(video);
                video.play();
            } else {
                const img = document.createElement('img');
                // Change: Use object-contain for the main media to show the whole image
                img.className = 'w-full h-full object-contain';
                img.src = mediaUrl;
                img.alt = `Story by ${story.author_username}`;
                storyMediaContainer.appendChild(img);
            }
            
            deleteBtnContainer.innerHTML = '';
            const currentUserId = {{ current_user.id }};
            if (story.user_id === currentUserId) {
                const deleteUrl = `{{ url_for('main.delete_story', story_id=0) }}`.replace('0', story.id);
                deleteBtnContainer.innerHTML = `
                    <form action="${deleteUrl}" method="POST"
                          onsubmit="return confirm('Are you sure you want to delete this story?');"
                          id="delete-story-form">
                        <input type="hidden" name="story_id" value="${story.id}">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition-colors shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </form>
                `;
            }

            progressBarContainer.innerHTML = '';
            storiesData.forEach((_, i) => {
                const progressDiv = document.createElement('div');
                progressDiv.className = 'flex-1 h-1 bg-white/30 rounded';
                if (i <= index) {
                    const filledBar = document.createElement('div');
                    filledBar.className = 'h-full bg-white rounded transition-all duration-300';
                    progressDiv.appendChild(filledBar);
                }
                progressBarContainer.appendChild(progressDiv);
            });
        }

        function showNextStory() {
            if (currentStoryIndex < storiesData.length - 1) {
                currentStoryIndex++;
                renderStory(currentStoryIndex);
            } else {
                window.location.href = "{{ url_for('main.feed') }}";
            }
        }

        function showPrevStory() {
            if (currentStoryIndex > 0) {
                currentStoryIndex--;
                renderStory(currentStoryIndex);
            }
        }

        nextBtn.addEventListener('click', showNextStory);
        prevBtn.addEventListener('click', showPrevStory);
        
        renderStory(currentStoryIndex);
    });
</script>
{% endblock %}